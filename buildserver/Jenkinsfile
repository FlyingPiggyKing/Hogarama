/**
 * If the slave container hung, then it could have the following reasons
 * 1. The images need to be downloaded, therfore it seems to hung
 * 2. A persistence volume claim is is used but the storage is not available
 */
podTemplate(label: 'mypod', cloud: 'openshift', containers: [
    containerTemplate(name: 'hogajama-maven-build', image: 'gdhet/hogarama-jenkins-slave-maven-rhel7-docker:3.5.0-jdk-8u144b01', ttyEnabled: true, command: 'cat',
                      workingDir: '/home/jenkins',
                      alwaysPullImage: true,
                      resourceRequestCpu: '100m',
                      resourceLimitCpu: '200m',
                      resourceRequestMemory: '512Mi',
                      resourceLimitMemory: '1024Mi',
                      volumes: [persistentVolumeClaim(mountPath: '/.m2/repository', claimName: 'maven-repo', readOnly: false)]),
    containerTemplate(name: 'mqtt-client-maven-build', image: 'gdhet/hogarama-jenkins-slave-maven-rhel7-docker:3.5.0-jdk-8u144b01', ttyEnabled: true, command: 'cat',
                      workingDir: '/home/jenkins',
                      alwaysPullImage: true,
                      resourceRequestCpu: '100m',
                      resourceLimitCpu: '200m',
                      resourceRequestMemory: '512Mi',
                      resourceLimitMemory: '1024Mi',
                      volumes: [persistentVolumeClaim(mountPath: '/.m2/repository', claimName: 'maven-repo', readOnly: false)])
  ]) {

    node('mypod') {
        stage('Build') {
            parallel
              'hogajama-maven-build': {
                git url: 'https://github.com/Gepardec/Hogarama.git', branch: "${env.GIT_REPO_REF}"
                container('mqtt-client-maven-build') {
                  sh "mvn clean install -f mqtt-client-java/mqtt-client/pom.xml"
                },
              'mqtt-client-maven-build': {
                  git url: 'https://github.com/Gepardec/Hogarama.git', branch: "${env.GIT_REPO_REF}"
                  container('mqtt-client-maven-build') {
                    sh "mvn clean install -f mqtt-client-java/mqtt-client/pom.xml"
                  },
                }
            }
        }
    }
}

// podTemplate(name: 'mavenPod', label: 'mavenPod', namepsace: 'hogarama-buildserver', cloud: 'openshift', containers: [
// containerTemplate(name: 'hogarama_maven',
//                     image: 'gdhet/hogarama-jenkins-slave-maven-rhel7-docker:3.5.0-jdk-8u144b01',
//                     ttyEnabled: true,
//                     command: 'cat',
//                     livenessProbe: containerLivenessProbe( execArgs: 'ls ${HOME}', initialDelaySeconds: 10, timeoutSeconds: 5, failureThreshold: 10, periodSeconds: 10, successThreshold: 1))],
//                     volumes: [persistentVolumeClaim(mountPath: '/.m2/repository', claimName: 'maven-repo', readOnly: false)]) {
//
// }
