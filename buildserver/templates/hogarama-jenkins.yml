kind: "Template"
apiVersion: "v1"
metadata:
  name: "hogarama-jenkins"
  annotations:
    openshift.io/display-name: "Jenkins (Hogarama)"
    description: "Jenkins Service for building and testing the Hogarama project"
    iconClass: "icon-jenkins"
    tags: "instant-app,jenkins"

parameters:
  - name: "JENKINS_SERVICE_NAME"
    displayName: "Jenkins service name"
    value: "hogarama-jenkins"
    required: true

  - name: "JNLP_SERVICE_NAME"
    displayName: "Jenkins service name"
    value: "hogarama-jenkins-jnlp"
    required: true

  - name: "GIT_REPO_URL"
    displayName: "Hogarama git repository url (use https:// instead of git://)"
    value: "https://github.com/Gepardec/Hogarama"
    required: true

  - name: "GIT_REPO_REF"
    displayName: "Hogarama branch"
    value: "openshift_jenkins_build"
    required: true

  - name: "KUBERNETES_MASTER"
    displayName: "The url to the openshift instance. (E.g.: https://192.168.42.195:8443)"
    value: "https://192.168.42.195:8443"
    required: true

  - name: "JENKINS_SLAVE_IMAGE_MAVEN"
    displayName: "The docker tag for the maven slave image"
    value: "gdhet/hogarama-jenkins-slave-maven-rhel7-docker:3.5.0-jdk-8u144b01"
    required: true

objects:
  - kind: "ServiceAccount"
    apiVersion: "v1"
    metadata:
      name: "${JENKINS_SERVICE_NAME}"
      annotations:
        serviceaccounts.openshift.io/oauth-redirectreference.jenkins: "{\"kind\":\"OAuthRedirectReference\",\"apiVersion\":\"v1\",\"reference\":{\"kind\":\"Route\",\"name\":\"${JENKINS_SERVICE_NAME}\"}}"

  - kind: "PersistentVolumeClaim"
    apiVersion: "v1"
    metadata:
      name: "${JENKINS_SERVICE_NAME}"
    spec:
      accessModes:
        - "ReadWriteOnce"
      resources:
        requests:
          storage: "1Gi"

  - kind: "RoleBinding"
    apiVersion: "v1"
    metadata:
      name: "${JENKINS_SERVICE_NAME}_edit"
    groupNames: null
    subjects:
      - name: "${JENKINS_SERVICE_NAME}"
        kind: "ServiceAccount"
    roleRef:
      name: "edit"

  - kind: "ImageStream"
    apiVersion: "v1"
    metadata:
      name: "${JENKINS_SERVICE_NAME}"
      labels:
        application: "${JENKINS_SERVICE_NAME}"

  - kind: "BuildConfig"
    apiVersion: "v1"
    metadata:
      name: "${JENKINS_SERVICE_NAME}"
      labels:
        application: "${JENKINS_SERVICE_NAME}"
    spec:
      source:
        type: "Git"
        git:
          uri: "${GIT_REPO_URL}"
          ref: "${GIT_REPO_REF}"
        contextDir: "buildserver/jenkins-s2i"
      strategy:
        type: "Source"
        sourceStrategy:
          from:
            kind: "ImageStreamTag"
            namespace: "openshift"
            name: "jenkins:latest"
      output:
        to:
          kind: "ImageStreamTag"
          name: "${JENKINS_SERVICE_NAME}:latest"
      triggers:
        - type: "ImageChange"
          imageChange:

  - kind: "DeploymentConfig"
    apiVersion: "v1"
    metadata:
      name: "${JENKINS_SERVICE_NAME}"
      annotations:
        template.alpha.openshift.io/wait-for-ready: "true"
    spec:
      strategy:
        type: "Recreate"
      replicas: "1"
      selector:
        name: "${JENKINS_SERVICE_NAME}"
      triggers:
        - type: "ImageChange"
          imageChangeParams:
            automatic: true
            containerNames:
              - "${JENKINS_SERVICE_NAME}"
            from:
              kind: "ImageStreamTag"
              name: "${JENKINS_SERVICE_NAME}:latest"
        - type: "ConfigChange"
      template:
        metadata:
          labels:
            name: "${JENKINS_SERVICE_NAME}"
        spec:
          serviceAccountName: "${JENKINS_SERVICE_NAME}"
          containers:
            - name: "${JENKINS_SERVICE_NAME}"
              image: " "
              readinessProbe:
                timeoutSeconds: 10
                initialDelaySeconds: 10
                httpGet:
                  path: "/login"
                  port: 8080
              livenessProbe:
                timeoutSeconds: 10
                initialDelaySeconds: 10
                failureThreshold: 10
                httpGet:
                  path: "/login"
                  port: 8080
              env:
                - name: "JENKINS_SERVICE_NAME"
                  value: "${JENKINS_SERVICE_NAME}"
                - name: "JNLP_SERVICE_NAME"
                  value: "${JNLP_SERVICE_NAME}"
                - name: "KUBERNETES_TRUST_CERTIFICATES"
                  value: "true"
                - name: "KUBERNETES_MASTER"
                  value: "${KUBERNETES_MASTER}"
                - name: "HOGARAMA_GIT_URL"
                  value: "GIT_REPO_URL"
                - name: "HOGARAMA_GIT_REF"
                  value: "GIT_REPO_REF"
                - name: "OPENSHIFT_JENKINS_JVM_ARCH"
                  value: "x86_64"
                - name: "OPENSHIFT_ENABLE_OAUTH"
                  value: "true"
                - name: "OPENSHIFT_ENABLE_REDIRECT_PROMPT"
                  value: "true"
              resources:
                limits:
                  memory: "4096Mi"
                  cpu: 2
              volumeMounts:
                - name: "${JENKINS_SERVICE_NAME}-data"
                  mountPath: "/var/lib/jenkins"
              terminationMessagePath: "/dev/termination.log"
              imagePullPolicy: "IfNotPresent"
              capabilities:
                securityContext:
                  capabilities:
                    privileged: false
          volumes:
            - name: "${JENKINS_SERVICE_NAME}-data"
              persistentVolumeClaim:
                claimName: ${JENKINS_SERVICE_NAME}
          restartPolicy: "Always"
          dnsPolicy: "ClusterFirst"

  - kind: "Route"
    apiVersion: "v1"
    metadata:
      name: "${JENKINS_SERVICE_NAME}"
      annotations:
        template.openshift.io/expose-uri: "http://{.spec.host}{.spec.path}"
    spec:
      to:
        kind: "Service"
        name: "${JENKINS_SERVICE_NAME}"
      tls:
        termination: "edge"
        insecureEdgeTerminationPolicy: "Redirect"

  - kind: "Service"
    apiVersion: "v1"
    metadata:
      name: "${JENKINS_SERVICE_NAME}"
      annotations:
        service.alpha.openshift.io/dependencies: "[{\"name\": \"${JNLP_SERVICE_NAME}\", \"namespace\": \"\", \"kind\": \"Service\"}]"
        service.openshift.io/infrastructure: "true"
    spec:
      ports:
        - name: "web"
          protocol: "TCP"
          port: 80
          targetPort: 8080
          nodePort: 0
      selector:
        name:  "${JENKINS_SERVICE_NAME}"
      type: "ClusterIP"
      sessionAffinity: "None"

  - kind: "Service"
    apiVersion: "v1"
    metadata:
      name: "${JNLP_SERVICE_NAME}"
    spec:
      ports:
        - name: "agent"
          protocol: "TCP"
          port: 50000
          targetPort: 50000
          nodePort: 0
      selector:
        name:  "${JENKINS_SERVICE_NAME}"
      type: "ClusterIP"
      sessionAffinity: "None"
